<!doctype html>
<html lang="pt-BR" class="page-transition">
<head>
ย ย <link rel="icon" href="favicon.ico" type="image/x-icon">
ย ย <meta charset="utf-8" />
ย ย <meta name="viewport" content="width=device-width,initial-scale=1" />
ย ย <title>Confirmaรงรฃo de Pedido - Delรญcias Tropicana</title>
ย ยย
ย ย <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
ย ย <link rel="stylesheet" href="style.css?v=14">ย
ย ยย
ย ย <style>
ย ย ย ย /* 1. Transiรงรฃo de Entrada da Pรกgina */
ย ย ย ย .fade-page {
ย ย ย ย ย ย opacity: 0;
ย ย ย ย ย ย transition: opacity 0.3s ease-in;
ย ย ย ย }
ย ย ย ย .fade-page.loaded {
ย ย ย ย ย ย opacity: 1;
ย ย ย ย }
ย ย ย ยย
ย ย ย ย /* 2. Transiรงรฃo de Saรญda (Ao clicar para mudar de pรกgina) */
ย ย ย ย .page-transition.fade-out .fade-page {
ย ย ย ย ย ย opacity: 0;
ย ย ย ย ย ย transition: opacity 0.3s ease-out;
ย ย ย ย }
ย ย ย ย /* 3. Evita que o scroll apareรงa durante a transiรงรฃo */
ย ย ย ย .page-transition.fade-out {
ย ย ย ย ย ย overflow: hidden;ย
ย ย ย ย }

ย ย ย ย /* โ ESTILOS DO RESUMO DO PEDIDO */
ย ย ย ย .resumo-content {
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย flex-direction: column;
ย ย ย ย ย ย gap: 15px;
ย ย ย ย ย ย padding: 15px 0;
ย ย ย ย }
ย ย ย ย .resumo-item {
ย ย ย ย ย ย font-size: 0.95rem;
ย ย ย ย ย ย line-height: 1.4;
ย ย ย ย ย ย padding-bottom: 10px;
ย ย ย ย ย ย border-bottom: 1px dotted #ccc;
ย ย ย ย }
ย ย ย ย .resumo-item:last-child {
ย ย ย ย ย ย border-bottom: none;
ย ย ย ย ย ย padding-bottom: 0;
ย ย ย ย }
ย ย ย ย .separator {
ย ย ย ย ย ย color: #999;
ย ย ย ย ย ย margin: 0 5px;
ย ย ย ย }
ย ย ย ย .detail-label {
ย ย ย ย ย ย font-weight: 600;
ย ย ย ย }
ย ย ย ย .item-price {
ย ย ย ย ย ย color: var(--color-alert, #e53935);ย
ย ย ย ย ย ย font-size: 1rem;
ย ย ย ย }

ย ย ย ย /* =======================================
ย ย ย ย ย* NOVO: ESTILOS DO CARTรO FIDELIDADE
ย ย ย ย ย* ======================================= */
ย ย ย ย .fidelidade-card {
ย ย ย ย ย ย background: #FFEB3B; /* Amarelo da logo (cor de destaque) */
ย ย ย ย ย ย padding: 20px;
ย ย ย ย ย ย border-radius: 12px;
ย ย ย ย ย ย margin: 25px 0; /* Espaรงo antes e depois do cartรฃo */
ย ย ย ย ย ย border: 2px solid #FFD740;
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
ย ย ย ย }
ย ย ย ย .fidelidade-card h3 {
ย ย ย ย ย ย margin-top: 0;
ย ย ย ย ย ย color: #222;
ย ย ย ย ย ย font-size: 1.3rem;
ย ย ย ย }
ย ย ย ย .selos-container {
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย justify-content: center;
ย ย ย ย ย ย flex-wrap: wrap;
ย ย ย ย ย ย gap: 8px;
ย ย ย ย ย ย margin: 15px 0 20px;
ย ย ย ย }
ย ย ย ย .selo {
ย ย ย ย ย ย width: 35px;
ย ย ย ย ย ย height: 35px;
ย ย ย ย ย ย border-radius: 50%;
ย ย ย ย ย ย background-color: #eee;
ย ย ย ย ย ย border: 2px solid #ccc;
ย ย ย ย ย ย line-height: 31px;
ย ย ย ย ย ย font-weight: 700;
ย ย ย ย ย ย color: #ccc;
ย ย ย ย ย ย font-size: 0.9em;
ย ย ย ย ย ย transition: all 0.2s ease;
ย ย ย ย }
ย ย ย ย .selo.earned {
ย ย ย ย ย ย /* Assumindo que 'style.css' tem uma variรกvel ou que vocรช define um verde de sucesso */
ย ย ย ย ย ย background-color: #4CAF50; /* Verde de sucesso */
ย ย ย ย ย ย border-color: #388e3c;
ย ย ย ย ย ย color: white;
ย ย ย ย }
ย ย ย ย #btnResgate.btn-whatsapp {
ย ย ย ย ย ย background-color: #4CAF50;
ย ย ย ย ย ย color: white;
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย ย ย transition: background-color 0.3s;
ย ย ย ย }
ย ย ย ย #btnResgate:disabled {
ย ย ย ย ย ย background-color: #ccc;
ย ย ย ย ย ย color: #666;
ย ย ย ย ย ย cursor: not-allowed;
ย ย ย ย }
ย ย </style>
ย ยย
</head>
<body class="fade-page">
ย ย <main class="container">
ย ย ย ย <section class="menu">
ย ย ย ย ย ย <h2>โ Quase lรก! Confira seu Pedido:</h2>

ย ย ย ย ย ย <div class="resumo-box section-card" id="resumoFinalContainer">
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <h3 class="section-title">Seu Nome</h3>
ย ย ย ย ย ย ย ย <div class="campo">
ย ย ย ย ย ย ย ย ย ย <input type="text" id="nameInputFinal" placeholder="Ex.: Claudiane" required>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #eee;">
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <h3 class="section-title">Resumo do Pedido</h3>
ย ย ย ย ย ย ย ย <div id="resumoPedido" class="resumo-content"></div>

ย ย ย ย ย ย ย ย <div id="fidelidadeCard" class="fidelidade-card">
ย ย ย ย ย ย ย ย ย ย <h3>Cartรฃo Fidelidade ๐</h3>
ย ย ย ย ย ย ย ย ย ย <p id="selosStatus">Vocรช tem <strong>0</strong> selos de 10.</p>
ย ย ย ย ย ย ย ย ย ย <div id="selosContainer" class="selos-container">
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <button id="btnResgate" class="btn" disabled>
ย ย ย ย ย ย ย ย ย ย ย ย Complete 10 selos para ganhar uma Salada GRรTIS!
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="confirmation-actions">ย
ย ย ย ย ย ย ย ย ย ย <div class="resumo-total-final resumo-total centralizado" id="totalAPagar"></div>

ย ย ย ย ย ย ย ย ย ย <button id="enviarPedido" class="btn btn-whatsapp">
ย ย ย ย ย ย ย ย ย ย ย ย Enviar Pedido via WhatsApp
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <button id="voltarMenu" class="btn btn-voltar">
ย ย ย ย ย ย ย ย ย ย ย ย Voltar e Adicionar Mais Saladas
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย </div>
ย ย ย ย </section>
ย ย </main>

ย ย <script>
ย ย ย ย // Assume-se que 'handlePageTransition' estรก definido globalmente em 'app.js' ou em 'index.html'
ย ย ย ย // Definido como fallback
ย ย ย ย if(typeof handlePageTransition !== 'function') {
ย ย ย ย ย ย window.handlePageTransition = function(url) {
ย ย ย ย ย ย ย ย document.documentElement.classList.add('fade-out');
ย ย ย ย ย ย ย ย setTimeout(() => { window.location.href = url; }, 300);
ย ย ย ย ย ย };
ย ย ย ย }

ย ย ย ย // Variรกvel global para o telefone
ย ย ย ย const phone = '5565993321761';ย

ย ย ย ย const formatCurrency = (value) => {
ย ย ย ย ย ย return new Intl.NumberFormat('pt-BR', {
ย ย ย ย ย ย ย ย style: 'currency',
ย ย ย ย ย ย ย ย currency: 'BRL'
ย ย ย ย ย ย }).format(value);
ย ย ย ย };

ย ย ย ย function calcularTotalGeral() {
ย ย ย ย ย ย const pedidosJSON = localStorage.getItem('tropicanaPedidos');
ย ย ย ย ย ย const pedidos = pedidosJSON ? JSON.parse(pedidosJSON) : [];
ย ย ย ย ย ย let totalPedido = 0;
ย ย ย ย ย ย pedidos.forEach(item => {
ย ย ย ย ย ย ย ย totalPedido += item.total;
ย ย ย ย ย ย });
ย ย ย ย ย ย return totalPedido;
ย ย ย ย }

ย ย ย ย // ======================================================
ย ย ย ย // FUNรรES DE FIDELIDADE (SEGURANรA ATUALIZADA - CHECKSUM)
ย ย ย ย // ======================================================
ย ย ย ย const MAX_SEALS = 10;
ย ย ย ย const SECRET_KEY = 42; // Escolha um nรบmero aleatรณrio (secreto) e mantenha-o constante!

ย ย ย ย /**
ย ย ย ย ย* Calcula um valor de verificaรงรฃo de integridade (Checksum) a partir do nรบmero de selos.
ย ย ย ย ย*/
ย ย ย ย function createChecksum(selos) {
ย ย ย ย ย ย // Fรณrmula: (Selos * Chave Secreta) + (Selos * 3)
ย ย ย ย ย ย return (selos * SECRET_KEY) + (selos * 3);
ย ย ย ย }

ย ย ย ย /**
ย ย ย ย ย* Recupera o nรบmero atual de selos do LocalStorage, validando a integridade.
ย ย ย ย ย*/
ย ย ย ย function getFidelidadeSelos() {
ย ย ย ย ย ย // Novo nome da chave no localStorage รฉ 'fidelidade_data'
ย ย ย ย ย ย const dataJSON = localStorage.getItem('fidelidade_data');
ย ย ย ย ย ยย
ย ย ย ย ย ย if (!dataJSON) {
ย ย ย ย ย ย ย ย return 0;
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const data = JSON.parse(dataJSON);
ย ย ย ย ย ย ย ย const selos = parseInt(data.selos);
ย ย ย ย ย ย ย ย const storedChecksum = parseInt(data.checksum);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // 1. Recalcula e compara o checksum
ย ย ย ย ย ย ย ย const calculatedChecksum = createChecksum(selos);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (calculatedChecksum === storedChecksum) {
ย ย ย ย ย ย ย ย ย ย return selos;
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย // DETECรรO DE MANIPULAรรO!
ย ย ย ย ย ย ย ย ย ย console.error("[SEGURANรA] Tentativa de manipulaรงรฃo do Cartรฃo Fidelidade detectada! Zerando selos.");
ย ย ย ย ย ย ย ย ย ย resetFidelidadeSelos();ย
ย ย ย ย ย ย ย ย ย ย return 0;ย
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย // Trata dados corrompidos ou ilegรญveis
ย ย ย ย ย ย ย ย console.error("[SEGURANรA] Dados de fidelidade corrompidos ou ilegรญveis.");
ย ย ย ย ย ย ย ย return 0;
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย /**
ย ย ย ย ย* Adiciona um selo ao LocalStorage e armazena o novo checksum.
ย ย ย ย ย*/
ย ย ย ย function addFidelidadeSelo() {
ย ย ย ย ย ย let selos = getFidelidadeSelos(); // A validaรงรฃo รฉ feita aqui
ย ย ย ย ย ยย
ย ย ย ย ย ย if (selos < MAX_SEALS) {
ย ย ย ย ย ย ย ย selos++;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Cria o novo objeto seguro com o checksum
ย ย ย ย ย ย ย ย const newData = {
ย ย ย ย ย ย ย ย ย ย selos: selos,
ย ย ย ย ย ย ย ย ย ย checksum: createChecksum(selos)
ย ย ย ย ย ย ย ย };
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย localStorage.setItem('fidelidade_data', JSON.stringify(newData));
ย ย ย ย ย ย ย ย console.log(`[FIDELIDADE] Selo adicionado! Total: ${selos}/${MAX_SEALS}`);
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย /**
ย ย ย ย ย* Zera a contagem de selos apรณs o resgate.
ย ย ย ย ย*/
ย ย ย ย function resetFidelidadeSelos() {
ย ย ย ย ย ย // Zera os selos e armazena o checksum correto para 0
ย ย ย ย ย ย const newData = {
ย ย ย ย ย ย ย ย selos: 0,
ย ย ย ย ย ย ย ย checksum: createChecksum(0)
ย ย ย ย ย ย };
ย ย ย ย ย ย localStorage.setItem('fidelidade_data', JSON.stringify(newData));
ย ย ย ย ย ย console.log('[FIDELIDADE] Selos zerados apรณs resgate.');
ย ย ย ย }


ย ย ย ย // ======================================================
ย ย ย ย // FUNรรO PARA GERAR O TEXTO DO WHATSAPP (ATUALIZADA COM STATUS FIDELIDADE)
ย ย ย ย // ======================================================
ย ย ย ย const getWhatsappText = (total) => {
ย ย ย ย ย ย const pedidos = JSON.parse(localStorage.getItem('tropicanaPedidos')) || [];
ย ย ย ย ย ย const name = localStorage.getItem('tropicanaName') || 'Cliente';

ย ย ย ย ย ย // NOVO: Obtรฉm o status do Cartรฃo Fidelidade de forma segura
ย ย ย ย ย ย const selosAtuais = getFidelidadeSelos();
ย ย ย ย ย ย const selosRestantes = MAX_SEALS - selosAtuais;
ย ย ย ย ย ยย
ย ย ย ย ย ย // Geraรงรฃo do Tรญtulo e Status de Fidelidade
ย ย ย ย ย ย let text = `*NOVO PEDIDO - DELรCIAS TROPICANA*\n\n`;
ย ย ย ย ย ย text += `Meu nome รฉ *${name.trim()}* e este รฉ o meu pedido:\n\n`;
ย ย ย ย ย ยย
ย ย ย ย ย ย // โ NOVO BLOCO DE MENSAGEM FIDELIDADE PARA CONTROLE INTERNO
ย ย ย ย ย ย if (selosAtuais === MAX_SEALS) {
ย ย ย ย ย ย ย ย // Se estiver pronto para resgate (status de selos cheios)
ย ย ย ย ย ย ย ย text += `*๐ CARTรO FIDELIDADE COMPLETO!*\n`;
ย ย ย ย ย ย ย ย text += `*>> O CLIENTE ESTร APTO A RESGATAR A SALADA GRรTIS.* \n`;
ย ย ย ย ย ย ย ย text += `(Se o resgate nรฃo for feito via botรฃo na tela, serรก feito manualmente aqui.)\n`;
ย ย ย ย ย ย ย ย text += `---------------------------------\n`;
ย ย ย ย ย ย } else if (selosAtuais > 0) {
ย ย ย ย ย ย ย ย // Se jรก tiver selos, mas nรฃo completou
ย ย ย ย ย ย ย ย text += `*โญ CARTรO FIDELIDADE: ${selosAtuais}/${MAX_SEALS} selos*\n`;
ย ย ย ย ย ย ย ย text += `(Faltam ${selosRestantes} selos para o prรชmio grรกtis!)\n`;
ย ย ย ย ย ย ย ย text += `---------------------------------\n`;
ย ย ย ย ย ย }
ย ย ย ย ย ย // FIM NOVO BLOCO

ย ย ย ย ย ย pedidos.forEach((item, index) => {
ย ย ย ย ย ย ย ย const precoUnitario = item.tamanho.preco;

ย ย ย ย ย ย ย ย text += `ITEM ${index + 1}\n`;ย
ย ย ย ย ย ย ย ย text += `Tamanho: ${item.tamanho.nome} โ ${formatCurrency(precoUnitario)}\n`;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (item.fruits && item.fruits.length > 0) {
ย ย ย ย ย ย ย ย ย ย text += `\n*Frutas (Grรกtis):*\n`;ย
ย ย ย ย ย ย ย ย ย ย item.fruits.forEach(fruta => {
ย ย ย ย ย ย ย ย ย ย ย ย text += `โข ${fruta.nome}\n`;
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย if (item.extras && item.extras.length > 0) {
ย ย ย ย ย ย ย ย ย ย text += `\n*Adicionais de Fruta (R$2,00 cada):*\n`;ย
ย ย ย ย ย ย ย ย ย ย item.extras.forEach(extra => {
ย ย ย ย ย ย ย ย ย ย ย ย text += `โข ${extra.nome}\n`;
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย if (item.acomp && item.acomp.length > 0) {
ย ย ย ย ย ย ย ย ย ย text += `\n*Acompanhamentos (Grรกtis):*\n`;ย
ย ย ย ย ย ย ย ย ย ย item.acomp.forEach(acomp => {
ย ย ย ย ย ย ย ย ย ย ย ย text += `* ${acomp.nome}\n`;
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const obs = item.observacoes || item.obs;
ย ย ย ย ย ย ย ย if (obs && obs.trim() !== '') {
ย ย ย ย ย ย ย ย ย ย const obsLimpa = obs.trim().replace(/\n/g, ' ');ย
ย ย ย ย ย ย ย ย ย ย text += `\n*Observaรงรตes*: ${obsLimpa}\n`;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย text += `\n*Subtotal: ${formatCurrency(item.total)}*\n`;ย
ย ย ย ย ย ย ย ย text += `---------------------------------\n`;ย
ย ย ย ย ย ย });

ย ย ย ย ย ย text += `\n\nAguardando a confirmaรงรฃo do pedido e o cรกlculo da taxa de entrega.\n\n`;ย
ย ย ย ย ย ย text += `*Obrigado!*`;ย
ย ย ย ย ย ย text += `\n\n*Valor Total R$ ${total.toFixed(2).replace('.', ',')}*`;

ย ย ย ย ย ย return text;
ย ย ย ย };

ย ย ย ย // ======================================================
ย ย ย ย // FUNรรO loadAndDisplayOrder
ย ย ย ย // ======================================================
ย ย ย ย function loadAndDisplayOrder() {
ย ย ย ย ย ยย
ย ย ย ย ย ย // 1. RECUPERAรรO DE DADOS
ย ย ย ย ย ย const pedidosJSON = localStorage.getItem('tropicanaPedidos');
ย ย ย ย ย ย const pedidos = pedidosJSON ? JSON.parse(pedidosJSON) : [];

ย ย ย ย ย ย // 2. REFERรNCIAS DO DOM
ย ย ย ย ย ย const resumoPedidoDiv = document.getElementById('resumoPedido');
ย ย ย ย ย ย const totalAPagarDiv = document.getElementById('totalAPagar');
ย ย ย ย ย ย const nameInput = document.getElementById('nameInputFinal');
ย ย ย ย ย ยย
ย ย ย ย ย ย // 3. RECUPERAรรO DE DADOS (Nome)
ย ย ย ย ย ย nameInput.value = localStorage.getItem('tropicanaName') || '';
ย ย ย ย ย ยย
ย ย ย ย ย ย // 4. CรLCULO E EXIBIรรO
ย ย ย ย ย ย let resumoTexto = '';
ย ย ย ย ย ย let totalPedido = 0;

ย ย ย ย ย ย if (pedidos.length === 0) {
ย ย ย ย ย ย ย ย resumoPedidoDiv.textContent = 'Nenhum pedido encontrado. Voltando ao menu...';
ย ย ย ย ย ย ย ย totalAPagarDiv.textContent = 'TOTAL: R$0,00';
ย ย ย ย ย ย ย ย handlePageTransition('index.html');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย // GERAรรO DE HTML
ย ย ย ย ย ย resumoTexto += pedidos.map((item, index) => {
ย ย ย ย ย ย ย ย const totalItem = item.total;ย
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย let linha = `<div class="resumo-item">`;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย linha += `<strong>1x Salada #${index + 1} (${item.tamanho.nome}):</strong> `;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย let detalhes = [];

ย ย ย ย ย ย ย ย if (item.fruits && item.fruits.length) detalhes.push(`Frutas: ${item.fruits.map(f => f.nome).join(', ')}`);
ย ย ย ย ย ย ย ย if (item.extras && item.extras.length) detalhes.push(`<span class="detail-label">Adic:</span> ${item.extras.map(e => e.nome).join(', ')}`);
ย ย ย ย ย ย ย ย if (item.acomp && item.acomp.length) detalhes.push(`<span class="detail-label">Acomp:</span> ${item.acomp.map(a => a.nome).join(', ')}`);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const obs = item.observacoes || item.obs;
ย ย ย ย ย ย ย ย if (obs) detalhes.push(`<span class="detail-label">Obs:</span> ${obs}`);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย linha += detalhes.join(' <span class="separator">|</span> ');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย linha += ` - <strong class="item-price">${formatCurrency(totalItem)}</strong>`;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย linha += `</div>`;ย

ย ย ย ย ย ย ย ย totalPedido += totalItem;
ย ย ย ย ย ย ย ย return linha;
ย ย ย ย ย ย }).join('');

ย ย ย ย ย ย resumoPedidoDiv.innerHTML = resumoTexto;
ย ย ย ย ย ย totalAPagarDiv.textContent = 'TOTAL: ' + formatCurrency(totalPedido);

ย ย ย ย ย ย // 5. LISTENERS
ย ย ย ย ย ย document.getElementById('enviarPedido').addEventListener('click', () => {
ย ย ย ย ย ย ย ย // 5.1 Validar campos
ย ย ย ย ย ย ย ย if (nameInput.value.trim() === '') {
ย ย ย ย ย ย ย ย ย ย alert('Por favor, preencha seu nome.');
ย ย ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย // 5.2 Salvar Nome
ย ย ย ย ย ย ย ย localStorage.setItem('tropicanaName', nameInput.value.trim());

ย ย ย ย ย ย ย ย const totalPedido = calcularTotalGeral();
ย ย ย ย ย ย ย ย // 5.3 Gera o texto para o WhatsApp com a nova formataรงรฃo
ย ย ย ย ย ย ย ย let whatsappText = getWhatsappText(totalPedido);

ย ย ย ย ย ย ย ย // โ AรรO CRรTICA: Adiciona o selo de fidelidade ANTES de limpar o storage
ย ย ย ย ย ย ย ย addFidelidadeSelo();ย
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // 5.4 REMOรรO DE EMOJIS (Para evitar caracteres estranhos na URL)
ย ย ย ย ย ย ย ย whatsappText = whatsappText.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|\uD83E[\uDC00-\uDFFF]|\u200D|\uFE0F/g, '');


ย ย ย ย ย ย ย ย // 5.5 Salva a mensagem no storage e redireciona para a tela de sucesso
ย ย ย ย ย ย ย ย localStorage.setItem('pedidoWhatsApp', whatsappText);

ย ย ย ย ย ย ย ย // 5.6 Limpa o localStorage de pedido
ย ย ย ย ย ย ย ย localStorage.removeItem('tropicanaPedidos');
ย ย ย ย ย ย ย ย localStorage.removeItem('tropicanaName');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // 5.7 Redireciona para a tela de sucesso
ย ย ย ย ย ย ย ย handlePageTransition('sucesso.html');ย
ย ย ย ย ย ย });

ย ย ย ย ย ย // Listener para o botรฃo de Voltar
ย ย ย ย ย ย document.getElementById('voltarMenu').addEventListener('click', () => {
ย ย ย ย ย ย ย ย localStorage.setItem('tropicanaName', nameInput.value.trim());
ย ย ย ย ย ย ย ย handlePageTransition('index.html');
ย ย ย ย ย ย });
ย ย ย ย ย ยย
ย ย ย ย ย ย // Listener para persistir nome no localStorage
ย ย ย ย ย ย nameInput.addEventListener('input', () => localStorage.setItem('tropicanaName', nameInput.value.trim()));

ย ย ย ย ย ย // ======================================================
ย ย ย ย ย ย // LรGICA DE EXIBIรรO DO CARTรO FIDELIDADE
ย ย ย ย ย ย // ======================================================
ย ย ย ย ย ย const selosAtuais = getFidelidadeSelos();
ย ย ย ย ย ย const container = document.getElementById('selosContainer');
ย ย ย ย ย ย const statusText = document.getElementById('selosStatus');
ย ย ย ย ย ย const btnResgate = document.getElementById('btnResgate');

ย ย ย ย ย ย if (container) {ย
ย ย ย ย ย ย ย ย // 1. Atualiza o status
ย ย ย ย ย ย ย ย statusText.innerHTML = `Vocรช tem <strong>${selosAtuais}</strong> selos de ${MAX_SEALS}.`;

ย ย ย ย ย ย ย ย // 2. Desenha os selos
ย ย ย ย ย ย ย ย container.innerHTML = ''; // Limpa antes de desenhar
ย ย ย ย ย ย ย ย for (let i = 1; i <= MAX_SEALS; i++) {
ย ย ย ย ย ย ย ย ย ย const seloDiv = document.createElement('div');
ย ย ย ย ย ย ย ย ย ย seloDiv.className = 'selo';
ย ย ย ย ย ย ย ย ย ย if (i <= selosAtuais) {
ย ย ย ย ย ย ย ย ย ย ย ย seloDiv.classList.add('earned');
ย ย ย ย ย ย ย ย ย ย ย ย seloDiv.textContent = 'โ';
ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย seloDiv.textContent = i;
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย container.appendChild(seloDiv);
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย // 3. Lรณgica do botรฃo de resgate
ย ย ย ย ย ย ย ย if (selosAtuais >= MAX_SEALS) {
ย ย ย ย ย ย ย ย ย ย btnResgate.disabled = false;
ย ย ย ย ย ย ย ย ย ย btnResgate.classList.add('btn-whatsapp');ย
ย ย ย ย ย ย ย ย ย ย btnResgate.textContent = '๐ RESGATE SEU PRรMIO GRรTIS AGORA! ๐';
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย btnResgate.onclick = function() {
ย ย ย ย ย ย ย ย ย ย ย ย if (confirm('Ao resgatar, seus selos serรฃo zerados e uma mensagem serรก enviada ao WhatsApp. Deseja continuar?')) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย // Cรณdigo de resgate simples para verificaรงรฃo manual
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const codigoResgate = 'DT' + Math.floor(Date.now() / 1000);ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const mensagem = `Olรก! Quero resgatar minha Salada de Frutas GRรTIS do Cartรฃo Fidelidade. Meu cรณdigo de resgate รฉ: ${codigoResgate}`;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const urlWhatsApp = `https://wa.me/${phone}?text=${encodeURIComponent(mensagem)}`;
ย ย ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย // Zera os selos no LocalStorage (usando a funรงรฃo segura)
ย ย ย ย ย ย ย ย ย ย ย ย ย ย resetFidelidadeSelos();

ย ย ย ย ย ย ย ย ย ย ย ย ย ย // Abre o WhatsApp
ย ย ย ย ย ย ย ย ย ย ย ย ย ย window.open(urlWhatsApp, '_blank');
ย ย ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย // Redireciona de volta ao menu apรณs o resgate
ย ย ย ย ย ย ย ย ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ยhandlePageTransition('index.html');
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }, 1000);
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย };
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย btnResgate.onclick = null; // Remove qualquer clique anterior
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย document.addEventListener('DOMContentLoaded', function() {
ย ย ย ย ย ย // Garante que a chave antiga (sem seguranรงa) seja removida na primeira execuรงรฃo
ย ย ย ย ย ย localStorage.removeItem('fidelidade_selos'); 
ย ย ย ย ย ยย
ย ย ย ย ย ย document.body.classList.add('loaded');
ย ย ย ย ย ย loadAndDisplayOrder();
ย ย ย ย });
ย ย </script>
ย ยย
ย ย </body>
</html>
