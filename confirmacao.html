<!doctype html>
<html lang="pt-BR" class="page-transition">
<head>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirma√ß√£o de Pedido - Del√≠cias Tropicana</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css?v=14"> 
  
  <style>
    /* 1. Transi√ß√£o de Entrada da P√°gina */
    .fade-page {
        opacity: 0;
        transition: opacity 0.3s ease-in;
    }
    .fade-page.loaded {
        opacity: 1;
    }
    
    /* 2. Transi√ß√£o de Sa√≠da (Ao clicar para mudar de p√°gina) */
    .page-transition.fade-out .fade-page {
        opacity: 0;
        transition: opacity 0.3s ease-out;
    }
    /* 3. Evita que o scroll apare√ßa durante a transi√ß√£o */
    .page-transition.fade-out {
        overflow: hidden; 
    }

    /* ‚úÖ NOVO: Estilos para o Resumo do Pedido */
    .resumo-content {
        /* Define um espa√ßamento controlado entre os itens do pedido */
        display: flex;
        flex-direction: column;
        gap: 15px; /* Espa√ßamento entre os itens */
        padding: 15px 0;
    }
    .resumo-item {
        font-size: 0.95rem;
        line-height: 1.4;
        padding-bottom: 10px;
        border-bottom: 1px dotted #ccc; /* Linha de separa√ß√£o entre itens */
    }
    .resumo-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    .separator {
        color: #999;
        margin: 0 5px;
    }
    .detail-label {
        font-weight: 600;
    }
    .item-price {
        /* Usa a cor de alerta para destacar o pre√ßo (assumindo que 'style.css' define --color-alert) */
        color: var(--color-alert, #e53935); 
        font-size: 1rem;
    }
  </style>
  
</head>
<body class="fade-page">
  <main class="container">
    <section class="menu">
      <h2>‚úÖ Quase l√°! Confira seu Pedido:</h2>

      <div class="resumo-box section-card" id="resumoFinalContainer">
          
          <h3 class="section-title">Seu Nome:</h3>
          <div class="campo"><span class="label">Nome</span>
              <input type="text" id="nameInputFinal" placeholder="Ex.: Claudiane" required>
          </div>
          <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #eee;">
          
          <h3 class="section-title">Resumo do Pedido:</h3>
          <div id="resumoPedido" class="resumo-content"></div>

          <div class="confirmation-actions"> 
              <div class="resumo-total-final resumo-total centralizado" id="totalAPagar"></div>

              <button id="enviarPedido" class="btn btn-whatsapp">
                  Enviar Pedido via WhatsApp
              </button>
              <button id="voltarMenu" class="btn btn-voltar">
                  Voltar e Adicionar Mais Saladas
              </button>
          </div>

      </div>
    </section>
  </main>

  <script>
    // A fun√ß√£o handlePageTransition deve ser exposta globalmente em app.js
    // Se n√£o estiver, esta linha pode falhar, mas deve funcionar se o app.js estiver carregado primeiro
    if(typeof handlePageTransition !== 'function') {
        window.handlePageTransition = function(url) {
            document.documentElement.classList.add('fade-out');
            setTimeout(() => { window.location.href = url; }, 300);
        };
    }

    // Vari√°vel global para o telefone
    const phone = '5565993321761'; 

    const formatCurrency = (value) => {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);
    };

    function calcularTotalGeral() {
        const pedidosJSON = localStorage.getItem('tropicanaPedidos');
        const pedidos = pedidosJSON ? JSON.parse(pedidosJSON) : [];
        let totalPedido = 0;
        pedidos.forEach(item => {
            totalPedido += item.total;
        });
        return totalPedido;
    }

// ======================================================
// FUN√á√ÉO PARA GERAR O TEXTO DO WHATSAPP (AGORA COM EMOJIS)
// ======================================================
const getWhatsappText = (total) => {
    // Recupera os pedidos do localStorage
    const pedidos = JSON.parse(localStorage.getItem('tropicanaPedidos')) || [];
    // Pega o nome diretamente do campo de input (mais seguro)
    const name = document.getElementById('nameInputFinal').value.trim() || 'Cliente'; 
    const FRUIT_LIMIT = 5; // Limite de frutas para o texto

    // 1. In√≠cio da Mensagem (NOVO FORMATO COM EMOJIS)
    let text = `üö® *NOVO PEDIDO - DEL√çCIAS TROPICANA* üçç\n\n`;
    text += `Ol√°, meu nome √© *${name}* üëã e aqui est√° o meu pedido:\n`;
    text += "---------------------------------\n";

    // 2. Loop pelos itens do pedido
    pedidos.forEach((item, index) => {
        const itemNumber = index + 1;
        
        text += `\nüëâ *ITEM ${itemNumber}:* Salada ${item.tamanho.nome}\n`;
        text += `*Tamanho:* ${item.tamanho.nome} | *Valor Base:* ${formatCurrency(item.tamanho.preco)}\n`;

        // Frutas
        if (item.fruits && item.fruits.length) {
            text += `\nüçì *Frutas (M√°x. ${FRUIT_LIMIT} Gr√°tis):*\n`;
            item.fruits.map(f => f.nome).forEach(fruit => {
                text += `‚Ä¢ ${fruit}\n`;
            });
        }

        // Extras
        if (item.extras && item.extras.length) {
            text += `\n‚ûï *Adicionais de Fruta (R$2,00 cada):*\n`;
            item.extras.map(e => e.nome).forEach(extra => {
                text += `‚Ä¢ ${extra}\n`;
            });
        }
        
        // Acompanhamentos
        if (item.acomp && item.acomp.length) {
            text += `\nü•Ñ *Acompanhamentos (Gr√°tis):*\n`;
            item.acomp.map(a => a.nome).forEach(acompItem => {
                text += `‚Ä¢ ${acompItem}\n`; 
            });
        }
        
        // Observa√ß√£o (Checa por 'observacoes' e 'obs')
        const obs = item.observacoes || item.obs;
        if (obs && obs.trim() !== '') {
            const obsLimpa = obs.trim().replace(/\n/g, ' '); 
            text += `\nüìù *Observa√ß√µes do Item:* ${obsLimpa}\n`;
        }
        
        // Subtotal do Item
        text += `\nüíµ *Subtotal do Item:* ${formatCurrency(item.total)}\n`;
        
        // Linha de separa√ß√£o entre itens
        text += `---------------------------------`; 
    });

    // 3. Rodap√©
    text += `\n\n‚úÖ Aguardo a confirma√ß√£o do pedido e o c√°lculo da taxa de entrega.`;
    text += `\n\n*Obrigado!* üôè`; 

    // Adiciona o valor total no final da mensagem do WhatsApp
    text += `\n\n*VALOR TOTAL DO PEDIDO:* üí∞ *${formatCurrency(total)}*`;

    // 4. Retorna a mensagem formatada
    return text;
};

// ======================================================
// FUN√á√ÉO loadAndDisplayOrder (CORRIGIDA)
// ======================================================
    function loadAndDisplayOrder() {
        
        // 1. RECUPERA√á√ÉO DE DADOS
        const pedidosJSON = localStorage.getItem('tropicanaPedidos');
        const pedidos = pedidosJSON ? JSON.parse(pedidosJSON) : [];

        // 2. REFER√äNCIAS DO DOM
        const resumoPedidoDiv = document.getElementById('resumoPedido');
        const totalAPagarDiv = document.getElementById('totalAPagar');
        const nameInput = document.getElementById('nameInputFinal');
        
        // 3. RECUPERA√á√ÉO DE DADOS (Nome)
        nameInput.value = localStorage.getItem('tropicanaName') || '';
        
        // 4. C√ÅLCULO E EXIBI√á√ÉO
        let resumoTexto = '';
        let totalPedido = 0;

        if (pedidos.length === 0) {
            resumoPedidoDiv.textContent = 'Nenhum pedido encontrado. Voltando ao menu...';
            totalAPagarDiv.textContent = 'TOTAL: R$0,00';
            handlePageTransition('index.html');
            return;
        }

        // GERA√á√ÉO DE HTML E ESTRUTURA PARA FORMATAR NO NAVEGADOR
        resumoTexto += pedidos.map((item, index) => {
            const totalItem = item.total; 
            
            // Inicia o container do item (que ser√° separado pelo CSS)
            let linha = `<div class="resumo-item">`;
            
            // T√≠tulo: 1x Salada #N (Tamanho)
            linha += `<strong>1x Salada #${index + 1} (${item.tamanho.nome}):</strong> `;
            
            let detalhes = [];

            // Frutas (Checa se o array existe e se tem conte√∫do)
            if (item.fruits && item.fruits.length) detalhes.push(`Frutas: ${item.fruits.map(f => f.nome).join(', ')}`);
            // Adicionais (Checa se o array existe e se tem conte√∫do)
            if (item.extras && item.extras.length) detalhes.push(`<span class="detail-label">Adic:</span> ${item.extras.map(e => e.nome).join(', ')}`);
            // Acompanhamentos (Checa se o array existe e se tem conte√∫do)
            if (item.acomp && item.acomp.length) detalhes.push(`<span class="detail-label">Acomp:</span> ${item.acomp.map(a => a.nome).join(', ')}`);
            
            // Observa√ß√£o (Checa se existe) - ‚úÖ CORRIGIDO: Checa por 'observacoes' e 'obs'
            const obs = item.observacoes || item.obs;
            if (obs) detalhes.push(`<span class="detail-label">Obs:</span> ${obs}`);
            
            // Junta os detalhes usando o separador com classe CSS
            linha += detalhes.join(' <span class="separator">|</span> ');
            
            // Pre√ßo total do item
            linha += ` - <strong class="item-price">${formatCurrency(totalItem)}</strong>`;
            
            // Fecha o container do item
            linha += `</div>`; 

            totalPedido += totalItem;
            return linha;
        }).join(''); // N√£o usa separador no join, pois o <div> j√° cria a separa√ß√£o

        resumoPedidoDiv.innerHTML = resumoTexto; // Usa innerHTML para renderizar o HTML
        totalAPagarDiv.textContent = 'TOTAL: ' + formatCurrency(totalPedido);

        // 5. LISTENERS
        document.getElementById('enviarPedido').addEventListener('click', () => {
             // 5.1 Validar campos
            if (nameInput.value.trim() === '') {
                alert('Por favor, preencha seu nome.');
                return;
            }
             // 5.2 Salvar Nome
            localStorage.setItem('tropicanaName', nameInput.value.trim());

            const totalPedido = calcularTotalGeral();
            // 5.3 Gera o texto para o WhatsApp com a nova formata√ß√£o
            let whatsappText = getWhatsappText(totalPedido);

            // ‚ùå LINHA REMOVIDA: A LINHA ABAIXO √â A QUE CAUSA CARACTERES ESTRANHOS.
            // whatsappText = whatsappText.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|\uD83E[\uDC00-\uDFFF]|\u200D|\uFE0F/g, '');


            // 5.4 Salva a mensagem no storage e redireciona para a tela de sucesso
            localStorage.setItem('pedidoWhatsApp', whatsappText);

            // 5.5 Limpa o localStorage de pedido (VOLTA √Ä ESTACA ZERO)
            localStorage.removeItem('tropicanaPedidos');
            localStorage.removeItem('tropicanaName');
            
            // 5.6 Redireciona para a tela de sucesso
            handlePageTransition('sucesso.html'); 
        });

        // Listener para o bot√£o de Voltar
        document.getElementById('voltarMenu').addEventListener('click', () => {
             // Salva o nome antes de voltar
             localStorage.setItem('tropicanaName', nameInput.value.trim());
             handlePageTransition('index.html');
        });
        
        // Listener para persistir nome no localStorage
        nameInput.addEventListener('input', () => localStorage.setItem('tropicanaName', nameInput.value.trim()));
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('loaded');
        loadAndDisplayOrder();
    });
  </script>
</body>
</html>
