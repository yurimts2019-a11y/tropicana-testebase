<!doctype html>
<html lang="pt-BR" class="page-transition">
<head>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmação de Pedido - Delícias Tropicana</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css?v=14"> 
  
  <style>
    /* 1. Transição de Entrada da Página */
    .fade-page {
        opacity: 0;
        transition: opacity 0.3s ease-in;
    }
    .fade-page.loaded {
        opacity: 1;
    }
    
    /* 2. Transição de Saída (Ao clicar para mudar de página) */
    .page-transition.fade-out .fade-page {
        opacity: 0;
        transition: opacity 0.3s ease-out;
    }
    /* 3. Evita que o scroll apareça durante a transição */
    .page-transition.fade-out {
        overflow: hidden; 
    }

    /* ✅ NOVO: Estilos para o Resumo do Pedido */
    .resumo-content {
        /* Define um espaçamento controlado entre os itens do pedido */
        display: flex;
        flex-direction: column;
        gap: 15px; /* Espaçamento entre os itens */
        padding: 15px 0;
    }
    .resumo-item {
        font-size: 0.95rem;
        line-height: 1.4;
        padding-bottom: 10px;
        border-bottom: 1px dotted #ccc; /* Linha de separação entre itens */
    }
    .resumo-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    .separator {
        color: #999;
        margin: 0 5px;
    }
    .detail-label {
        font-weight: 600;
    }
    .item-price {
        /* Usa a cor de alerta para destacar o preço (assumindo que 'style.css' define --color-alert) */
        color: var(--color-alert, #e53935); 
        font-size: 1rem;
    }
  </style>
  
</head>
<body class="fade-page">
  <main class="container">
    <section class="menu">
      <h2>✅ Quase lá! Confira seu Pedido:</h2>

      <div class="resumo-box section-card" id="resumoFinalContainer">
          
          <h3 class="section-title">Seu Nome:</h3>
          <div class="campo"><span class="label">Nome</span>
              <input type="text" id="nameInputFinal" placeholder="Ex.: Claudiane" required>
          </div>
          <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #eee;">
          
          <h3 class="section-title">Resumo do Pedido:</h3>
          <div id="resumoPedido" class="resumo-content"></div>

          <div class="confirmation-actions"> 
              <div class="resumo-total-final resumo-total centralizado" id="totalAPagar"></div>

              <button id="enviarPedido" class="btn btn-whatsapp">
                  Enviar Pedido via WhatsApp
              </button>
              <button id="voltarMenu" class="btn btn-voltar">
                  Voltar e Adicionar Mais Saladas
              </button>
          </div>

      </div>
    </section>
  </main>

  <script>
    // A função handlePageTransition deve ser exposta globalmente em app.js
    if(typeof handlePageTransition !== 'function') {
        window.handlePageTransition = function(url) {
            document.documentElement.classList.add('fade-out');
            setTimeout(() => { window.location.href = url; }, 300);
        };
    }

    // Variável global para o telefone
    const phone = '5565993321761'; 

    const formatCurrency = (value) => {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);
    };

    function calcularTotalGeral() {
        const pedidosJSON = localStorage.getItem('tropicanaPedidos');
        const pedidos = pedidosJSON ? JSON.parse(pedidosJSON) : [];
        let totalPedido = 0;
        pedidos.forEach(item => {
            totalPedido += item.total;
        });
        return totalPedido;
    }

// ======================================================
// FUNÇÃO PARA GERAR O TEXTO DO WHATSAPP (CORRIGIDA)
// ======================================================
const getWhatsappText = (total) => {
    // Recupera os pedidos do localStorage
    const pedidos = JSON.parse(localStorage.getItem('tropicanaPedidos')) || [];
    const name = localStorage.getItem('tropicanaName') || 'Cliente';

    // 1. Início da Mensagem (NOVO FORMATO LIMPO COM NEGRITO NO TÍTULO E NOME)
    let text = `*NOVO PEDIDO - DELÍCIAS TROPICANA*\n\n`; // Dupla quebra para separar o título da mensagem
    text += `Meu nome é *${name.trim()}* e este é o meu pedido:\n\n`; // Dupla quebra para separar a introdução do primeiro item
    
    // 2. Loop pelos itens do pedido
    pedidos.forEach((item, index) => {
        const precoUnitario = item.tamanho.preco;

        // Título do Item - AGORA COM APENAS UMA QUEBRA DE LINHA NO FINAL
        text += `ITEM ${index + 1}\n`; 
        
        // Tamanho e Preço
        text += `Tamanho: ${item.tamanho.nome} — ${formatCurrency(precoUnitario)}\n`;
        
        // Categoria 1: Frutas (Grátis)
        if (item.fruits && item.fruits.length > 0) {
            // Usa dupla quebra para separar o item.tamanho da categoria
            text += `\n*Frutas (Grátis):*\n`;
            item.fruits.forEach(fruta => {
                text += `• ${fruta.nome}\n`;
            });
        }
        
        // Categoria 2: Adicionais de Frutas (Extras Pagos)
        if (item.extras && item.extras.length > 0) {
            text += `\n*Adicionais de Fruta (R$2,00 cada):*\n`;
            item.extras.forEach(extra => {
                text += `• ${extra.nome}\n`;
            });
        }
        
        // Categoria 3: Acompanhamentos (Grátis)
        if (item.acomp && item.acomp.length > 0) {
            text += `\n*Acompanhamentos (Grátis):*\n`;
            item.acomp.forEach(acomp => {
                text += `* ${acomp.nome}\n`;
            });
        }

        // Observação (Se existir) - ✅ CORRIGIDO: Checa por 'observacoes' e 'obs'
        const obs = item.obs || item.observacoes;
        if (obs && obs.trim() !== '') {
            text += `\n*Observação:*\n${obs.trim()}\n`; // Uma quebra antes da obs, e uma depois
        }
        
        text += `\n*Total Item ${index + 1}:* ${formatCurrency(item.total)}\n\n`; // Dupla quebra para separar o item do próximo
    });
    
    // 3. Total Final
    text += `=========================\n`;
    text += `*TOTAL FINAL DO PEDIDO: ${formatCurrency(total)}*\n`;
    text += `=========================\n\n`;
    text += `Aguardando confirmação de endereço e pagamento.`;

    return text;
};


// ======================================================
// FUNÇÃO PARA RENDERIZAR O RESUMO NA TELA
// ======================================================
function renderizarResumoFinal() {
    const pedidosJSON = localStorage.getItem('tropicanaPedidos');
    const pedidos = pedidosJSON ? JSON.parse(pedidosJSON) : [];
    const resumoDiv = document.getElementById('resumoPedido');
    let totalPedido = 0;
    
    resumoDiv.innerHTML = '';
    
    if (pedidos.length === 0) {
        resumoDiv.innerHTML = '<p>Seu carrinho está vazio. Volte ao menu para montar seu pedido!</p>';
        document.getElementById('enviarPedido').disabled = true;
        document.getElementById('totalAPagar').textContent = '';
        return;
    }

    pedidos.forEach((item, index) => {
        let details = [];
        
        // Tamanho
        details.push(`Tamanho: ${item.tamanho.nome}`);
        
        // Frutas
        if (item.fruits && item.fruits.length > 0) {
            details.push(`Frutas (Grátis): ${item.fruits.map(f => f.nome.split(' ')[1]).join(', ')}`);
        }
        // Extras
        if (item.extras && item.extras.length > 0) {
            const custoExtras = item.extras.length * 2;
            details.push(`Adicionais (+R$${custoExtras},00): ${item.extras.map(e => e.nome.split(' ')[1]).join(', ')}`);
        }
        // Acompanhamentos
        if (item.acomp && item.acomp.length > 0) {
            details.push(`Acompanhamentos: ${item.acomp.map(a => a.nome).join(', ')}`);
        }
        // Observações
        const obs = item.obs || item.observacoes;
        if (obs && obs.trim() !== '') {
            details.push(`OBS: ${obs.trim()}`);
        }

        const itemDiv = document.createElement('div');
        itemDiv.className = 'resumo-item';
        itemDiv.innerHTML = `
            <div>
                <strong>ITEM ${index + 1}: Salada ${item.tamanho.nome}</strong> 
                <span class="item-price"> (${formatCurrency(item.total)})</span>
            </div>
            <p style="margin: 5px 0 0; color: #555;">${details.join(' | ')}</p>
        `;
        resumoDiv.appendChild(itemDiv);
        totalPedido += item.total;
    });
    
    document.getElementById('totalAPagar').innerHTML = `
        <span class="detail-label">Total a Pagar:</span> ${formatCurrency(totalPedido)}
    `;
    
    return totalPedido;
}

// ======================================================
// LISTENERS E INICIALIZAÇÃO
// ======================================================
function initConfirmationPage() {
    const totalPedido = renderizarResumoFinal();
    const nameInput = document.getElementById('nameInputFinal');

    // Tenta preencher o nome salvo
    const savedName = localStorage.getItem('tropicanaName');
    if (savedName) {
        nameInput.value = savedName;
    }

    // Listener para o botão de Enviar
    document.getElementById('enviarPedido').addEventListener('click', () => {
        
        if (!totalPedido || totalPedido === 0) {
             alert('Seu pedido está vazio. Não é possível enviar.');
             return;
        }

        if (nameInput.value.trim().length < 2) {
            alert('Por favor, digite seu nome para enviar o pedido.');
            nameInput.focus();
            return;
        }
        
        // 5.1 Salva o nome final
        localStorage.setItem('tropicanaName', nameInput.value.trim());

        // 5.2 Recalcula o total (embora já tenhamos)
        const totalFinal = calcularTotalGeral();

        // 5.3 Gera o texto para o WhatsApp com a nova formatação
        let whatsappText = getWhatsappText(totalFinal);

        // ✅ REMOÇÃO DE EMOJIS (Para evitar caracteres estranhos na URL)
        whatsappText = whatsappText.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|\uD83E[\uDC00-\uDFFF]|\u200D|\uFE0F/g, '');


        // 5.4 Salva a mensagem no storage e redireciona para a tela de sucesso
        localStorage.setItem('pedidoWhatsApp', whatsappText);

        // 5.5 Limpa o localStorage de pedido (VOLTA À ESTACA ZERO)
        localStorage.removeItem('tropicanaPedidos');
        localStorage.removeItem('tropicanaName');
        
        // ✅ LINHA CHAVE: Redireciona para a tela de sucesso com a transição
        handlePageTransition('sucesso.html');
    });

    // Listener para o botão de Voltar
    document.getElementById('voltarMenu').addEventListener('click', () => {
         // Salva o nome antes de voltar
         localStorage.setItem('tropicanaName', nameInput.value.trim());
         // ✅ LINHA CHAVE: Volta ao menu com a transição
         handlePageTransition('index.html');
    });
    
    // Listener para persistir nome no localStorage
    nameInput.addEventListener('input', () => localStorage.setItem('tropicanaName', nameInput.value.trim()));
}

document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('loaded');
    initConfirmationPage();
});
</script>
</body>
</html>
